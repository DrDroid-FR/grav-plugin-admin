{% extends "forms/field.html.twig" %}

{% block input %}
    {% set permissions = grav.permissions %}
    {% set access = permissions.access(value) %}
    {% set tu = grav.twig.twig.filters['tu'] is defined %}
    {% if object and field.check_authorize %}
        {% set auth_badges = true %}
        {% set super = object.authorize('admin.super', 'test') %}
    {% endif %}

    {% set classes = { 0: 'status-unchecked', 1: 'status-checked', ' ': 'status-indeterminate' } %}

    {% if field.data_type == 'access' %}
        {% set groupsList = [
            { label: 'Site', value: 'site' },
            { label: 'Admin', value: 'admin' }
        ] %}

        {% set optionsList = [
            { text: 'Site (site)', value: 'site', optgroup: 'site' },
            { text: 'Site Login (site.login)', value: 'site.login', optgroup: 'site' },
            { text: 'Admin (admin)', value: 'admin', optgroup: 'admin' },
            { text: 'Admin Login (admin.login)', value: 'admin.login', optgroup: 'admin' },
            { text: 'Admin Cache (admin.cache)', value: 'admin.cache', optgroup: 'admin' },
            { text: 'User Accounts (admin.users)', value: 'admin.users', optgroup: 'admin' }
        ] %}
    {% elseif field.data_type == 'permissions' %}
        {% set groupsList = [] %}
        {% set crudp = {
            c: { title: 'Create', value: '' },
            r: { title: 'Read', value: '' },
            u: { title: 'Update', value: '' },
            d: { title: 'Delete', value: '' },
            p: { title: 'Publish', value: '' }
        } %}
        {% set optionsList = [
            { text: 'Authors', value: 'authors' },
            { text: 'Manager', value: 'manager' },
            { text: 'Denied', value: 'denied' }
        ] %}
    {% endif %}

    <template data-id="acl_picker-{{ field.name }}">
        <div class="permissions-item" data-field-type="{{ field.data_type }}">
            <a href="#" class="remove-item"><i class="fa fa-trash"></i></a>
            <select data-grav-selectize="{{ { options: optionsList, optgroups: groupsList }|json_encode }}"></select>

            {% if field.data_type == 'access' %}
            <div class="switch-toggle switch-grav medium switch-3">
                <input type="radio" value="1" id="{{ field.name ~ '_' }}" name="{{ (scope ~ field.name)|fieldName ~ '[]' }}" class="label1" checked>

                <label for="{{ field.name ~ '_' }}">{{ tu ? 'PLUGIN_ADMIN.ALLOWED'|tu : 'PLUGIN_ADMIN.ALLOWED'|t }}</label>

                <input type="radio" value="0" id="{{ field.name ~ '_' }}" name="{{ (scope ~ field.name)|fieldName ~ '[]' }}" class="label0">

                <label for="{{ field.name ~ '_' }}">{{ tu ? 'PLUGIN_ADMIN.DENIED'|tu : 'PLUGIN_ADMIN.DENIED'|t }}</label>

            </div>
            {% elseif field.data_type == 'permissions' %}
                <div class="crudp-container" data-field-name="{{ (scope ~ field.name)|fieldName ~ '[]' }}">
                    {% for key,button in crudp %}
                        <div>
                            <span class="checkboxes indeterminate toggleable status-unchecked hint--top"
                                  data-_check-status="0"
                                  data-hint="{{ button.title }}">
                                <input type="checkbox"
                                       id="{{ field.name ~ '_' ~ key ~ '_' }}"
                                       data-crudp-key="{{ key }}"
                                       name="{{ (scope ~ field.name)|fieldName ~ '[][' ~ key ~ ']' }}"
                                       indeterminte="false" value=" ">
                                <label for="{{ field.name ~ '_' ~ key ~ '_' }}">{{ key }}</label>
                            </span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            <button class="button add-item"><i class="fa fa-plus"></i></button>
        </div>
    </template>


    <div class="permissions-container" data-acl_picker_id="{{ field.name }}" data-acl_picker="{{ { options: optionsList, optgroups: groupsList }|json_encode }}">
        <div class="permissions-item empty-list {{ value|length ? 'hidden' }}">
            <a href="#" class="button add-item"><i class="fa fa-plus"></i></a>
        </div>


        value:
        {{ value|json_encode}}
        {% for key, access in value %}
            <div class="permissions-item" data-field-type="{{ field.data_type }}">
                <a href="#" class="remove-item"><i class="fa fa-trash"></i></a>
                <select data-grav-selectize="{{ { options: optionsList, optgroups: groupsList }|json_encode }}">
                    <option value="{{ key }}" selected>{{ key }}</option>
                </select>
                {% if field.data_type == 'access' %}
                <div class="switch-toggle switch-grav medium switch-3">
                    {% set rnd = random(100) %}
                    <input type="radio" value="1" id="{{ field.name ~ '_' ~ rnd }}" name="{{ (scope ~ field.name)|fieldName ~ '[' ~ key ~ ']' }}" class="label1" {{ access ? 'checked' }}>

                    <label for="{{ field.name ~ '_' ~ rnd }}">{{ tu ? 'PLUGIN_ADMIN.ALLOWED'|tu : 'PLUGIN_ADMIN.ALLOWED'|t }}</label>

                    {% set rnd = random(100) %}
                    <input type="radio" value="0" id="{{ field.name ~ '_' ~ rnd }}" name="{{ (scope ~ field.name)|fieldName ~ '[' ~ key ~ ']' }}" class="label0" {{ not access ? 'checked' }}>

                    <label for="{{ field.name ~ '_' ~ rnd }}">{{ tu ? 'PLUGIN_ADMIN.DENIED'|tu : 'PLUGIN_ADMIN.DENIED'|t }}</label>

                </div>
                {% elseif field.data_type == 'permissions' %}
                    <div class="crudp-container" data-field-name="{{ (scope ~ field.name)|fieldName ~ '[]' }}">
                        {% for crudp_key, button in crudp %}
                            <div>
                                {% set crudp_value = value[key][crudp_key] %}
                            <span class="checkboxes indeterminate toggleable {{ classes[crudp_value]}} hint--top"
                                  data-_check-status="{{ crudp_value == ' ' ? 2 : crudp_value }}"
                                  data-hint="{{ button.title }}">
                                <input type="checkbox"
                                       id="{{ field.name ~ '_' ~ crudp_key ~ '_' }}"
                                       data-crudp-key="{{ crudp_key }}"
                                       name="{{ (scope ~ field.name)|fieldName ~ '[][' ~ crudp_key ~ ']' }}"
                                       indeterminate="false" value=" "
                                       indeterminate="{{ crudp_value == ' ' ? 'true' : 'false' }}" value="{{ crudp_value }}" {% if crudp_value == 1 %}checked{% endif %}>
                                <label for="{{ field.name ~ '_' ~ crudp_key ~ '_' }}">{{ crudp_key }}</label>
                            </span>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                <button class="button add-item"><i class="fa fa-plus"></i></button>
            </div>
        {% endfor %}
    </div>
{% endblock %}
